<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <title>Valuation Report - [[${valuation.ownerName}]]</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 24px;
      color: #111;
      line-height: 1.4;
    }

    h1 {
      font-size: 22px;
      margin-bottom: 8px;
    }

    .section {
      margin-top: 12px;
    }

    .label {
      font-weight: bold;
      width: 220px;
      display: inline-block;
    }

    .kv {
      margin-bottom: 8px;
    }

    .report-paragraph {
      text-align: justify;
      margin-top: 12px;
    }

    .footer {
      margin-top: 28px;
      font-size: 12px;
      color: #666;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }

    td,
    th {
      padding: 6px;
      vertical-align: top;
    }

    /* small controls */
    .controls {
      margin-top: 16px;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .btn {
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }

    .btn-edit {
      background: #f0ad4e;
      color: #111;
    }

    .btn-save {
      background: #28a745;
      color: #fff;
    }

    .btn-cancel {
      background: #6c757d;
      color: #fff;
    }

    .btn-pdf {
      background: #0d6efd;
      color: #fff;
    }

    /* modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .modal {
      background: white;
      padding: 18px;
      border-radius: 8px;
      width: 320px;
      box-shadow: 0 6px 22px rgba(0, 0, 0, 0.25);
    }

    .modal .row {
      margin-top: 12px;
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .input-inline {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      min-width: 200px;
    }

    .readonly {
      display: inline-block;
      min-width: 200px;
    }

    .status {
      margin-left: 8px;
      font-size: 0.95rem;
      color: #2b7a2b;
      min-width: 220px;
    }

    .error {
      color: #b02a37;
      font-weight: 600;
    }
  </style>
</head>

<body>
  <h1>Valuation Report</h1>

  <!-- Thymeleaf will set a data-id attribute with the numeric id -->
  <div id="meta" th:data-id="${valuation.id}"></div>

  <div class="section" id="fields">
    <!-- each field: label + either readonly span OR input (hidden by default) -->
    <div class="kv">
      <span class="label">Owner Name:</span>
      <span class="readonly" id="ownerNameText" th:text="${valuation.ownerName}">Owner</span>
      <input class="input-inline" id="ownerNameInput" type="text" th:value="${valuation.ownerName}"
        style="display:none;" />
    </div>

    <div class="kv">
      <span class="label">Owner Mobile:</span>
      <span class="readonly" id="ownerMobileText" th:text="${valuation.ownerMobile}">Mobile</span>
      <input class="input-inline" id="ownerMobileInput" type="text" th:value="${valuation.ownerMobile}"
        style="display:none;" />
    </div>

    <div class="kv">
      <span class="label">Property Address:</span>
      <span class="readonly" id="addressText" th:text="${valuation.address}">Address</span>
      <textarea class="input-inline" id="addressInput" style="display:none;" rows="2"
        th:text="${valuation.address}"></textarea>
    </div>

    <div class="kv">
      <span class="label">Carpet Area (sq.ft):</span>
      <span class="readonly" id="carpetAreaText" th:text="${valuation.carpetArea}">1000</span>
      <input class="input-inline" id="carpetAreaInput" type="number" step="0.01" th:value="${valuation.carpetArea}"
        style="display:none;" />
    </div>

    <div class="kv">
      <span class="label">Possession:</span>
      <span class="readonly" id="possessionText" th:text="${valuation.possession}">Possession</span>
      <input class="input-inline" id="possessionInput" type="text" th:value="${valuation.possession}"
        style="display:none;" />
    </div>

    <div class="kv">
      <span class="label">Created At:</span>
      <span class="readonly" id="createdAtText" th:text="${createdAt}">2025-09-28T00:00</span>
    </div>
  </div>

  <div class="controls">
    <button id="editBtn" class="btn btn-edit">Edit</button>
    <button id="saveBtn" class="btn btn-save" style="display:none;">Save</button>
    <button id="cancelBtn" class="btn btn-cancel" style="display:none;">Cancel</button>
    <button id="downloadPdf" class="btn btn-pdf">Download PDF</button>
    <div id="opStatus" class="status" aria-live="polite"></div>
  </div>

  <div class="section report-paragraph" id="narrative">
    <p>
      This valuation report for the property owned by
      <strong id="ownerNameNarrative" th:text="${valuation.ownerName}">Owner Name</strong>
      located at <strong id="addressNarrative" th:text="${valuation.address}">Property Address</strong>
      reflects the current valuation based on inspection and market comparables.
      The property is under <strong id="possessionNarrative" th:text="${valuation.possession}">Possession</strong>
      and the carpet area is <strong id="carpetAreaNarrative" th:text="${valuation.carpetArea}">Area</strong> sq.ft.
    </p>
  </div>

  <div class="footer">
    Report generated on <span id="generationDate" th:text="${generationDate}">2025-09-28</span>.
  </div>

  <!-- Confirmation modal -->
  <div id="confirmModal" class="modal-backdrop" role="dialog" aria-modal="true" style="display:none;">
    <div class="modal" role="document" aria-labelledby="confirmTitle">
      <div id="confirmTitle"><strong>Confirm update</strong></div>
      <div id="confirmText" style="margin-top:8px;">Do you want to save changes to this valuation?</div>
      <div class="row">
        <button id="confirmNo" class="btn btn-cancel">No</button>
        <button id="confirmYes" class="btn btn-save">Yes</button>
      </div>
    </div>
  </div>

  <script>
    (function () {
      // Elements
      const metaEl = document.getElementById('meta');
      const rawId = metaEl ? metaEl.dataset.id : null;
      const id = rawId ? Number(rawId) : null;
      const editBtn = document.getElementById('editBtn');
      const saveBtn = document.getElementById('saveBtn');
      const cancelBtn = document.getElementById('cancelBtn');
      const downloadPdfBtn = document.getElementById('downloadPdf');
      const modal = document.getElementById('confirmModal');
      const confirmYes = document.getElementById('confirmYes');
      const confirmNo = document.getElementById('confirmNo');
      const status = document.getElementById('opStatus');

      if (!id) {
        status.innerHTML = '<span class="error">Invalid resource id — cannot edit.</span>';
      }

      // mapping fields
      const fields = [
        { textId: 'ownerNameText', inputId: 'ownerNameInput', narrativeId: 'ownerNameNarrative', key: 'ownerName' },
        { textId: 'ownerMobileText', inputId: 'ownerMobileInput', narrativeId: null, key: 'ownerMobile' },
        { textId: 'addressText', inputId: 'addressInput', narrativeId: 'addressNarrative', key: 'address' },
        { textId: 'carpetAreaText', inputId: 'carpetAreaInput', narrativeId: 'carpetAreaNarrative', key: 'carpetArea' },
        { textId: 'possessionText', inputId: 'possessionInput', narrativeId: 'possessionNarrative', key: 'possession' }
      ];

      // helper to toggle edit mode
      function setEditMode(on) {
        fields.forEach(f => {
          const textEl = document.getElementById(f.textId);
          const inputEl = document.getElementById(f.inputId);
          if (textEl) textEl.style.display = on ? 'none' : 'inline-block';
          if (inputEl) inputEl.style.display = on ? 'inline-block' : 'none';
        });
        editBtn.style.display = on ? 'none' : 'inline-block';
        saveBtn.style.display = on ? 'inline-block' : 'none';
        cancelBtn.style.display = on ? 'inline-block' : 'none';
      }

      // Read only changed fields (diff)
      function readInputsChangedOnly() {
        const payload = {};
        fields.forEach(f => {
          const textEl = document.getElementById(f.textId);
          const inputEl = document.getElementById(f.inputId);
          if (!textEl || !inputEl) return;

          const original = (textEl.textContent || '').trim();
          let current = inputEl.value;

          if (f.key === 'carpetArea') {
            // normalize numbers: empty => null, else parse
            if (String(current).trim() === '') {
              current = null;
            } else {
              const parsed = parseFloat(String(current).replace(/,/g, ''));
              if (Number.isNaN(parsed)) {
                // Keep the raw value (client will validate)
                current = inputEl.value;
              } else {
                current = parsed;
              }
            }
          } else {
            current = String(current).trim();
          }

          // Normalize original for numeric compare
          const originalNormalized = (f.key === 'carpetArea')
            ? (original === '' ? null : parseFloat(original))
            : original;

          const changed = (current !== originalNormalized);

          if (changed) {
            // send null or actual value
            payload[f.key] = (current === '') ? null : current;
          }
        });
        return payload;
      }

      function applyUpdatedValues(obj) {
        fields.forEach(f => {
          const newVal = obj[f.key];
          const textEl = document.getElementById(f.textId);
          const inputEl = document.getElementById(f.inputId);
          if (newVal === null || newVal === undefined) {
            if (textEl) textEl.textContent = '';
            if (inputEl && (inputEl.tagName === 'INPUT' || inputEl.tagName === 'TEXTAREA')) inputEl.value = '';
          } else {
            if (textEl) textEl.textContent = newVal;
            if (inputEl && (inputEl.tagName === 'INPUT' || inputEl.tagName === 'TEXTAREA')) inputEl.value = newVal;
          }
          if (f.narrativeId) {
            const el = document.getElementById(f.narrativeId);
            if (el) el.textContent = newVal;
          }
        });
      }

      function showModal(show) {
        modal.style.display = show ? 'flex' : 'none';
      }

      // events
      editBtn.addEventListener('click', () => {
        setEditMode(true);
        status.textContent = '';
      });

      cancelBtn.addEventListener('click', () => {
        // revert inputs to read-only values
        fields.forEach(f => {
          const text = document.getElementById(f.textId).textContent;
          const input = document.getElementById(f.inputId);
          if (input) input.value = text;
        });
        setEditMode(false);
        status.textContent = '';
      });

      saveBtn.addEventListener('click', () => {
        // basic client-side validation before confirmation: if ownerName input is visible and empty -> block
        const ownerInput = document.getElementById('ownerNameInput');
        if (ownerInput && ownerInput.style.display !== 'none') {
          const nameValue = (ownerInput.value || '').trim();
          if (nameValue === '') {
            status.innerHTML = '<span class="error">Owner Name is required. Please enter a name before saving.</span>';
            ownerInput.focus();
            return;
          }
        }
        showModal(true);
      });

      confirmNo.addEventListener('click', () => {
        showModal(false);
        // remain in edit mode (user can continue editing)
      });

      confirmYes.addEventListener('click', async () => {
        showModal(false);
        status.textContent = 'Saving...';

        if (!id) {
          status.innerHTML = '<span class="error">Invalid resource id</span>';
          return;
        }

        const payload = readInputsChangedOnly();

        if (!payload || Object.keys(payload).length === 0) {
          status.innerHTML = '<span class="error">No changes detected to save.</span>';
          return;
        }

        // Prevent sending empty required fields (ownerName)
        if (payload.hasOwnProperty('ownerName') && (!payload.ownerName || String(payload.ownerName).trim() === '')) {
          status.innerHTML = '<span class="error">Owner Name cannot be empty.</span>';
          return;
        }

        try {
          const resp = await fetch(`/api/valuations/${id}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify(payload)
          });

          if (!resp.ok) {
            // Try parse json error (validation map) else text
            const ct = resp.headers.get('content-type') || '';
            let errText = '';
            if (ct.includes('application/json')) {
              const errJson = await resp.json();
              if (errJson && typeof errJson === 'object') {
                errText = Object.entries(errJson).map(([k, v]) => `${k}: ${v}`).join(' ; ');
              } else {
                errText = JSON.stringify(errJson);
              }
            } else {
              errText = await resp.text();
            }
            status.innerHTML = `<span class="error">Update failed (${resp.status}): ${errText}</span>`;
            return;
          }

          const updated = await resp.json();
          applyUpdatedValues(updated);

          if (updated.createdAt) {
            document.getElementById('createdAtText').textContent = updated.createdAt;
          }

          setEditMode(false);
          status.textContent = 'Saved ✅';
          setTimeout(() => { status.textContent = ''; }, 3500);
        } catch (err) {
          console.error(err);
          status.innerHTML = '<span class="error">Network error while updating</span>';
        }
      });

      // download pdf button
      downloadPdfBtn.addEventListener('click', () => {
        if (!id) {
          status.innerHTML = '<span class="error">Invalid resource id</span>';
          return;
        }
        window.open(`/api/valuations/${id}/pdf`, '_blank');
      });

      // Initialize: ensure inputs match displayed values (in case template rendering differs)
      fields.forEach(f => {
        const text = document.getElementById(f.textId).textContent;
        const input = document.getElementById(f.inputId);
        if (input) input.value = text;
      });
    })();
  </script>
</body>

</html>
